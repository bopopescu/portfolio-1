var TWITIO=TWITIO||{REVISION:"01"};TWITIO.width=1280;TWITIO.height=720;TWITIO.FPS=10;TWITIO.Composition=function(){this.container=null;this.camera=null;this.scene=null;this.renderer=null;this.projector=null;this.lightFront=null;this.lightBottom=null;this.callbacks=null;this.mousePressed=false;this.id=null;this.pieces=new Array()};TWITIO.Composition.prototype={constructor:TWITIO.Composition,screenshot:function(d,c){var g=this.renderer.domElement.toDataURL("image/png");var b=dataURItoBlob(g);var a=window.URL||window.webkitURL||window.mozURL||window.msURL;url=a.createObjectURL(b);var f=document.createElement("a");f.setAttribute("href",url);if(d.indexOf(".png")==-1&&d.length!=0){d=d+".png"}if(c==true){f.setAttribute("download",d||"screenshot.png");var e=document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,window,1,0,0,0,0,false,false,false,false,0,null);f.dispatchEvent(e)}return g},getSize:function(){var a={};a.width=TWITIO.width;a.height=TWITIO.height;return a},init:function(a){this.container=document.getElementById(a);var b=TWITIO.width/TWITIO.height;this.scene=new THREE.Scene();this.camera=new THREE.OrthographicCamera(TWITIO.width/-2,TWITIO.width/2,TWITIO.height/2,TWITIO.height/-2,-1000,1000);this.renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});this.renderer.setSize(TWITIO.width,TWITIO.height);this.scene.add(this.camera);this.container.appendChild(this.renderer.domElement);this.lightFront=new THREE.PointLight(16777215,1.5);this.lightFront.position.y=400;this.scene.add(this.lightFront);this.lightBottom=new THREE.DirectionalLight(16777215,1.3);this.lightBottom.position.y=-240;this.scene.add(this.lightBottom)},createPiece:function(d,a,i,h,e,m,l,k){var j=new THREE.JSONLoader();var n=new TWITIO.Piece();var c=this;var b=new XMLHttpRequest();var f=new FormData(document.forms[0]);function g(o){n.make(o);n.setX(i);n.setX(h);n.setScale(e);n.setRotX(m);n.setRotY(l);n.setRotZ(k);n.setFilename(a);c.scene.add(n.object);c.pieces.push(n);f.append("filename",a);b.open("POST","/delete",true);b.send(f)}j.load(d,g)},animate:function(c,a){if(c!="edit"){for(var b;b<a.pieces.length;b++){a.pieces[b].createSprings();a.updateVertexSprings()}}a.renderer.render(a.scene,a.camera);a.id=setTimeout(a.animate,TWITIO.FPS/1000,"normal",a)},stop:function(){window.clearTimeout(this.id)}};TWITIO.Piece=function(){this.meshMaterial=null;this.object=null;this.scale=1;this.x=0;this.y=0;this.rotX=0;this.rotY=0;this.rotZ=0;this.filename=null;this.DISPLACEMENT=0.2;this.SPRING_STRENGTH=0.0009;this.DAMPEN=0.97;this.DEPTH=600};TWITIO.Piece.prototype={constructor:TWITIO.Piece,setX:function(a){this.x+=a;this.object.position.x=this.x},setY:function(a){this.y+=a;this.object.position.y=this.y},setRotX:function(a){this.rotX=a;this.object.rotation.x=this.rotX},setRotY:function(a){this.y_rot=a},setRotZ:function(a){this.z_rot=a},setFilename:function(a){this.filename=a},setScale:function(a){this.scale=a},setDisplacement:function(a){this.DISPLACEMENT=a},setSpringStrenght:function(a){this.SPRING_STRENGTH=a},setDampen:function(a){this.DAMPEN=a},make:function(c){var b=["/static/img/mirror.jpg","/static/img/mirror.jpg","/static/img/mirror.jpg","/static/img/mirror.jpg","/static/img/mirror.jpg","/static/img/mirror.jpg"];var a=THREE.ImageUtils.loadTextureCube(b);this.geometry=c;this.meshMaterial=new THREE.MeshLambertMaterial({color:15724527,shininess:50,envMap:a,shading:THREE.SmoothShading});this.object=new THREE.Mesh(this.geometry,this.meshMaterial);this.object.geometry.dynamic=true},makeSprings:function(){var a=this.object.geometry.faces;for(var c=0;c<a.length;c++){var b=a[c];if(b instanceof THREE.Face3){this.createSpring(b.a,b.b);this.createSpring(b.b,b.c);this.createSpring(b.c,b.a)}else{this.createSpring(b.a,b.b);this.createSpring(b.b,b.c);this.createSpring(b.c,b.d);this.createSpring(b.d,b.a)}}},createSpring:function(e,b){var d=this.object.geometry.vertices;var c=d[e];var a=d[b];if(!c.springs){c.springs=[];c.normal=c.position.clone().normalize();c.originalPosition=c.position.clone()}if(!a.springs){a.springs=[];a.normal=c.position.clone().normalize();a.originalPosition=a.position.clone()}if(!c.velocity){c.velocity=new THREE.Vector3()}c.springs.push({start:c,end:a,length:c.position.length(a.position)})},displaceFace:function(a,b){this.displaceVertex(a.a,b);this.displaceVertex(a.b,b);this.displaceVertex(a.c,b);if(a instanceof THREE.Face4){this.displaceVertex(a.d,b)}},displaceVertex:function(a,b){var c=this.object.geometry.vertices;c[a].velocity.addSelf(c[a].normal.clone().multiplyScalar(b))},updateVertexSprings:function(){var i=this.object.geometry.vertices,a=i.length,j=null,c=null,h=0,d=0,b=0,f=null,e=new THREE.Vector3(0,0,0);while(a--){f=i[a];j=f.springs;if(!j){continue}for(var g=0;g<j.length;g++){c=j[g];d=c.start.position.length(c.end.position);h=c.length-d;e.copy(c.start.normal).multiplyScalar(h*this.SPRING_STRENGTH);c.start.velocity.addSelf(e);e.copy(c.end.normal).multiplyScalar(h*this.SPRING_STRENGTH);c.end.velocity.addSelf(e);c.start.position.addSelf(c.start.velocity);c.end.position.addSelf(c.end.velocity);c.start.velocity.multiplyScalar(this.DAMPEN);c.end.velocity.multiplyScalar(this.DAMPEN)}f.position.addSelf(f.originalPosition.clone().subSelf(f.position).multiplyScalar(0.03))}}};var mode="none",template="1";var holder,tests={},support={},acceptedTypes={},fileupload;var filename;var intervalMakeMovieID,movieID,frameCounter,recording=new Boolean(),FRAMES_PER_MINUTE=12;var objCounter=0;function initialize(){$("#icon-loading").css("visibility","hidden");holder=document.getElementById("holder");tests={filereader:typeof FileReader!="undefined",dnd:"draggable" in document.createElement("span"),formdata:!!window.FormData,progress:"upload" in new XMLHttpRequest};support={filereader:document.getElementById("filereader"),formdata:document.getElementById("formdata"),progress:document.getElementById("progress")};acceptedTypes={"image/png":true,"image/jpeg":true,"image/gif":true,"application/octet-stream":true};fileupload=document.getElementById("upload");"filereader formdata progress".split(" ").forEach(function(a){if(tests[a]===false){support[a].className="fail"}else{support[a].className="hidden"}});if(tests.dnd){holder.ondragover=function(){this.className="hover";return false};holder.ondragend=function(){this.className="";return false};holder.ondrop=function(a){this.className="";a.preventDefault();readfiles(a.dataTransfer.files)}}else{fileupload.className="hidden";fileupload.querySelector("input").onchange=function(){readfiles(this.files)}}mode="none";template="1";toggleButtons()}function edit(){if(mode=="none"){console.log("enter edit mode");mode="edit";toggleButtons()}else{if(mode=="edit"){console.log("exit edit mode");mode="none";toggleButtons();if(composition.pieces.length!=0){setModal("save","composition");$("#btn-save").click(function(c){var b=$("#input-save-filename").val();if(b.indexOf(".json")==-1&&b.length!=0){b=b+".json"}var a=exportCompositionTemplate();saveAs(a,b||"composition.json")});$("#btn-share").click(function(a){setModal("share","composition");$("#modal-share").modal()});$("#btn-share-final").click(function(b){console.log("share template composition");var a=exportCompositionTemplate();var c=composition.screenshot("thumbnail.png",false);var d=dataURItoBlob(c);shareMedia("composition",a,d)});$("#modal-save").modal()}else{myWarning("No pieces were found in the composition.")}}}}function screenshot(){if(mode=="none"){console.log("enter sceenshot mode");if(composition.pieces.length!=0){setModal("save","screenshot");$("#btn-save").click(function(b){var a=$("#input-save-filename").val();composition.screenshot(a,true)});$("#btn-share").click(function(a){setModal("share","screenshot");$("#modal-share").modal()});$("#btn-share-final").click(function(b){var c=composition.screenshot(filename,true);var a=dataURItoBlob(c);shareMedia("screenshot",a,null)});$("#modal-save").modal()}else{myWarning("No pieces were found in the composition.")}}}function makemovie(){if(mode=="none"){console.log("enter makemovie mode");mode="makemovie";toggleButtons();var c=composition.getSize();var e=new XMLHttpRequest();var b=new FormData(document.forms[0]);var d=c.width;b.append("width",d);var a=c.height;b.append("height",a);e.onload=function(f){movieID=e.response;frameCounter=0;intervalMakeMovieID=setInterval(takeSceenshot,Math.ceil(60000/FRAMES_PER_MINUTE))};e.open("POST","/movieid",true);e.send(b)}else{if(mode=="makemovie"){console.log("exit makemovie mode");clearInterval(intervalMakeMovieID);mode="none";toggleButtons();setModal("save","movie");$("#btn-save").click(function(j){var f=$("#input-save-filename").val();var k=new Date().getTime();var f=(f.replace(/ /g,"")||"movie")+"_"+k+".mp4";var m=new XMLHttpRequest(),l=new XMLHttpRequest();m.responseType="arraybuffer";var h=new FormData(document.forms[0]),g=new FormData(document.forms[0]);h.append("movieid",movieID);h.append("filename",f);var i=function(o){if(m.status===200){var p=new DataView(m.response);var n=new Blob([p],{type:"movie/mp4"});saveAs(n,f);g.append("filename",movieID);l.open("POST","/delete",true);l.send(g)}};m.open("POST","/savemovie",true);m.onload=i;m.send(h)});$("#btn-share").click(function(f){setModal("share","movie");$("#modal-share").modal()});$("#btn-share-final").click(function(g){var l=$("#input-title").val();var m=$("#input-description").val();var j=$("#input-author").val();var h=$("#input-website").val();var k=new Date().getTime();var f=(l.replace(/ /g,"")||"movie")+"_"+k+".mp4";var n=new XMLHttpRequest();var i=new FormData(document.forms[0]);i.append("filename",f);i.append("movieid",movieID);i.append("author",j||"anonymous");i.append("description",m||"no description");i.append("title",l||"no title");i.append("website",h||"#");n.open("POST","/sharemovie",true);while(recording){console.log("waiting for recording to end")}n.send(i)});$("#modal-save").modal()}}}function fullscreen(){if(mode=="none"){console.log("enter fullscreen mode");mode="fullscreen";toggleButtons();THREEx.FullScreen.request();screenfull.request()}else{if(mode=="fullscreen"){console.log("exit fullscreen mode");mode="none";toggleButtons();screenfull.exit();THREEx.FullScreen.cancel()}}}function takeSceenshot(){recording=true;var c=frameCounter+"_frame.png";var e=composition.screenshot(c,false);frameCounter++;var b=dataURItoBlob(e);var d=new FormData(document.forms[0]);var f=new XMLHttpRequest();d.append("img",b,c);d.append("movieid",movieID);f.open("POST","/frame",true);var a=function(g){recording=false};f.onload=a;f.send(d)}function readfiles(b){var c=tests.formdata?new FormData():null;var a=b[0].name;if(a.indexOf(".json")!=-1){importCompositionTemplate(b[0]);return 1}else{if(a.indexOf(".obj")!=-1){if(tests.formdata){c.append("fileupload",b[0])}toggleUploadUI("uploading");if(tests.formdata){var d=new XMLHttpRequest();d.open("POST","/compose",true);d.onload=function(){progress.value=progress.innerHTML=100;a=d.getResponseHeader("Location");a=a.replace("http://cisonogiatutte.com:5000/","");console.log(a);toggleUploadUI("uploaded");var e="/download?filename="+a+"&mimetype=text/json&folder=objects";composition.createPiece(e,a,0,0,1,0,0,0)};if(tests.progress){d.upload.onprogress=function(f){if(f.lengthComputable){var e=(f.loaded/f.total*100|0)+"%";$("#upload-bar").css("width",e)}}}d.send(c)}}else{myAlert("UNRECOGNIZED file extension (allowed extensions: .obj and .json)","error")}}}function exportCompositionTemplate(){var j={};var h={};var d={};d.formatVersion="0.1";d.extension=".json";d.generatedOn=new Date();d.sourceType="TWITIO";d.pieces=1;j.metadata=d;for(var b=0;b<composition.pieces.length;b++){d={};d.filename=composition.pieces[b].filename;d.x=composition.pieces[b].x;d.y=composition.pieces[b].y;d.scale=composition.pieces[b].scale;d.rotX=composition.pieces[b].rotX;d.rotY=composition.pieces[b].rotY;d.rotZ=composition.pieces[b].rotZ;d.DISPLACEMENT=composition.pieces[b].DISPLACEMENT;d.SPRING_STRENGTH=composition.pieces[b].SPRING_STRENGTH;d.DAMPEN=composition.pieces[b].DAMPEN;var c="obj-"+b;h[c]=d}j.pieces=h;var e=JSON.stringify(j);var f=str2ab(e);var g=new DataView(f);var a=new Blob([g],{type:"text/json"});return a}function importCompositionTemplate(a){var b=new FileReader();b.onload=function(g){var f=g.target.result;for(var c=0;c<f.length;c++){if(f.charCodeAt(c)==0){f=f.replaceAt(c,"")}}var d={};d=JSON.parse(f);console.log(d)};b.readAsText(a)}function shareMedia(f,i,d){var h=$("#input-title").val();var k=$("#input-description").val();var e=$("#input-author").val();var b=$("#input-website").val();var g=new Date().getTime();var j="";var l=new XMLHttpRequest();var c=new FormData(document.forms[0]);if(f=="screenshot"){l.open("POST","/sharescreenshot",true);j=".png"}if(f=="composition"){l.open("POST","/sharecomposition",true);c.append("thumbnail",d,"thumbnail_"+g+".png");j=".json"}var a=(h.replace(/ /g,"")||f)+"_"+g+j;c.append("file",i,a);c.append("author",e||"anonymous");c.append("description",k||"no description");c.append("title",h||"no title");c.append("website",b||"#");l.send(c)}function loadComposition(a){template=a;toggleButtonsTemplate();if(a=="new"){for(var b=0;b<composition.pieces.length;b++){composition.scene.removeObject(composition.pieces[0].object)}composition.pieces=[];mode="edit";toggleButtons()}else{}}function myAlert(b,a){if(a=="info"){$("#modal-alert-label").html("TWITIO - info");$("#msg-info").html(b);$("#msg-info").css("display","block");$("#msg-error").css("display","none")}else{if(a=="error"){$("#modal-alert-label").html("TWITIO - error");$("#msg-error").html(b);$("#msg-error").css("display","block");$("#msg-info").css("display","none")}}$("#modal-alert").modal()}function myWarning(a){if(a.length!=0){$("#alert-warnings").html('<div style="margin-top: 6px; margin-bottom: 0px;" class="alert"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Warning!</strong> '+a+"</div>");$("#alert-warnings").css("display","block");$("#divider-warnings").css("display","block")}else{$("#alert-warnings").css("display","none");$("#divider-warnings").css("display","none")}}function toggleUploadUI(a){switch(a){case ("uploading"):$("#upload-bar").css("width","0%");$("#upload-bar-container").css("display","block");$("#info-container").css("display","none");break;case ("uploaded"):$("#info-container").css("display","block");$("#upload-bar-container").css("display","none");break;case ("off"):$("#upload-container").css("display","none");break;case ("on"):$("#upload-bar-container").css("display","none");$("#upload-container").css("display","block");break}}function loadingGif(a){if(a=="on"){$("#icon-loading").css("visibility","visible")}else{$("#icon-loading").css("visibility","hidden")}}function setModal(a,b){if(a=="save"){$("#btn-save").unbind();$("#btn-share").unbind();$("#btn-share-final").unbind();switch(b){case ("screenshot"):$("#modal-save-label").html("Save screenshot");$("#input-save-filename").attr("placeholder","screenshot.jpg");break;case ("movie"):$("#modal-save-label").html("Save movie");$("#input-save-filename").attr("placeholder","movie.mp4");break;case ("composition"):$("#modal-save-label").html("Export composition");$("#input-save-filename").attr("placeholder","composition.json");break}}else{if(a=="share"){switch(b){case ("screenshot"):$("#modal-share-label").html("Share screenshot");break;case ("movie"):$("#modal-share-label").html("Share movie");break;case ("composition"):$("#modal-share-label").html("Share composition");break}}}}function toggleButtonsTemplate(){if(mode=="none"){switch(template){case ("1"):$("#btn-comp-1").attr("class","btn btn-large btn-success enabled");$("#btn-comp-2").attr("class","btn btn-large enabled");$("#btn-comp-new").attr("class","btn btn-large enabled");break;case ("2"):$("#btn-comp-1").attr("class","btn btn-large enabled");$("#btn-comp-2").attr("class","btn btn-large btn-success enabled");$("#btn-comp-new").attr("class","btn btn-large enabled");break;case ("new"):$("#btn-comp-1").attr("class","btn btn-large enabled");$("#btn-comp-2").attr("class","btn btn-large enabled");$("#btn-comp-new").attr("class","btn btn-large enabled");break}}else{switch(template){case ("1"):$("#btn-comp-1").attr("class","btn btn-large btn-success disabled");$("#btn-comp-2").attr("class","btn btn-large disabled");$("#btn-comp-new").attr("class","btn btn-large disabled");break;case ("2"):$("#btn-comp-1").attr("class","btn btn-large disabled");$("#btn-comp-2").attr("class","btn btn-large btn-success disabled");$("#btn-comp-new").attr("class","btn btn-large disabled");break;case ("new"):$("#btn-comp-1").attr("class","btn btn-large disabled");$("#btn-comp-2").attr("class","btn btn-large disabled");$("#btn-comp-new").attr("class","btn btn-large disabled");break}}}function toggleButtons(){myWarning("");switch(mode){case ("none"):$("#btn-edit").html("<i class='icon-wrench icon-white'></i>");$("#btn-edit").attr("title","edit/add 3D objects");$("#btn-screenshot").html("<i class='icon-camera icon-white'></i>");$("#btn-makemovie").html("<i class='icon-film icon-white'></i>");$("#btn-fullscreen").html("<i class='icon-fullscreen icon-white'></i>");$("#btn-edit").attr("class","btn btn-primary btn-large enabled");$("#btn-makemovie").attr("class","btn btn-primary btn-large enabled");$("#btn-screenshot").attr("class","btn btn-primary btn-large enabled");$("#btn-fullscreen").attr("class","btn btn-primary btn-large enabled pull-right");toggleUploadUI("off");toggleButtonsTemplate();break;case ("edit"):$("#btn-edit").html("<i class='icon-ok icon-white'></i>");$("#btn-edit").attr("title","stop editing");$("#btn-edit").attr("class","btn btn-success btn-large");$("#btn-screenshot").attr("class","btn btn-primary btn-large disabled");$("#btn-makemovie").attr("class","btn btn-primary btn-large disabled");$("#btn-fullscreen").attr("class","btn btn-primary btn-large disabled pull-right");toggleUploadUI("on");toggleButtonsTemplate();break;case ("makemovie"):$("#btn-makemovie").html("<i class='icon-stop icon-white'></i>");$("#btn-makemovie").attr("class","btn btn-danger btn-large");$("#btn-edit").attr("class","btn btn-primary btn-large disabled");$("#btn-screenshot").attr("class","btn btn-primary btn-large disabled");$("#btn-fullscreen").attr("class","btn btn-primary btn-large disabled pull-right");toggleUploadUI("off");toggleButtonsTemplate();break;case ("fullscreen"):$("#btn-fullscreen").html("<i class='icon-resize-small icon-white'></i>");$("#btn-makemovie").attr("class","btn btn-primary btn-large");toggleUploadUI("off");toggleButtonsTemplate();break}}function download(b,e){var g=new XMLHttpRequest(),f=new XMLHttpRequest();var a;var d=new FormData(document.forms[0]),c=new FormData(document.forms[0]);g.responseType="arraybuffer";if(e=="screenshot"){d.append("folder","gallery");a="image/png"}else{if(e=="movie"){d.append("folder","movies");a="movie/mp4";b=b+".mp4"}else{if(e=="composition"){d.append("folder","compositions");a="text/json"}else{return -1}}}d.append("filename",b);d.append("mimetype",a);g.open("POST","/download",true);g.onload=function(i){var j=new DataView(g.response);var h=new Blob([j],{type:a});saveAs(h,b);c.append("filename",b);f.open("POST","/delete",true);f.send(c)};g.send(d)}function dataURItoBlob(e,k){var d=atob(e.split(",")[1]);var c=e.split(",")[0].split(":")[1].split(";")[0];var l=new ArrayBuffer(d.length);var b=new Uint8Array(l);for(var g=0;g<d.length;g++){b[g]=d.charCodeAt(g)}window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(typeof window.BlobBuilder!=="undefined"){var h=new window.BlobBuilder();h.append(l);return h.getBlob(c)}else{var g=b.length;var f=new Array(g);while(g--){f[g]=String.fromCharCode(b[g])}var a;if(typeof window.DataView!="undefined"){var j=new DataView(l);a=new Blob([j],{type:c})}else{a=new Blob([l],{type:c})}return a}}function base64ArrayBuffer(h){var g="";var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var r=new Uint8Array(h);var p=r.byteLength;var f=p%3;var q=p-f;var o,m,l,j;var n;for(var e=0;e<q;e=e+3){n=(r[e]<<16)|(r[e+1]<<8)|r[e+2];o=(n&16515072)>>18;m=(n&258048)>>12;l=(n&4032)>>6;j=n&63;g+=k[o]+k[m]+k[l]+k[j]}if(f==1){n=r[q];o=(n&252)>>2;m=(n&3)<<4;g+=k[o]+k[m]+"=="}else{if(f==2){n=(r[q]<<8)|r[q+1];o=(n&64512)>>10;m=(n&1008)>>4;l=(n&15)<<2;g+=k[o]+k[m]+k[l]+"="}}return g}function str2ab(e){var b=new ArrayBuffer(e.length*2);var a=new Uint16Array(b);for(var c=0,d=e.length;c<d;c++){a[c]=e.charCodeAt(c)}return b}String.prototype.replaceAt=function(b,a){if(b>this.length||b<0){return this.substr(0,this.length)}else{return this.substr(0,b)+a+this.substr(b+1,this.length)}};